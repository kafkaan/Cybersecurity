# Attacking Domain Trusts - Cross-Forest Trust Abuse - from Linux

***

### <mark style="color:blue;">Cross-Forest Kerberoasting</mark>

**Using GetUserSPNs.py**

{% code overflow="wrap" fullWidth="true" %}
```shell-session
mrroboteLiot@htb[/htb]$ GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley
```
{% endcode %}

Rerunning the command with the `-request` flag added gives us the TGS ticket. We could also add `-outputfile <OUTPUT FILE>` to output directly into a file that we could then turn around and run Hashcat against.

**Using the -request Flag**

{% code fullWidth="true" %}
```shell-session
mrroboteLiot@htb[/htb]$ GetUserSPNs.py -request -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley  
```
{% endcode %}

On peut essayer de **craquer le hash hors ligne** avec Hashcat en mode 13100. Si cela réussit, on pourra s'authentifier sur le domaine **FREIGHTLOGISTICS.LOCAL** en tant qu'**administrateur du domaine**.

Si cette attaque fonctionne lors d'un audit réel, il est utile de **vérifier si le même compte existe dans notre domaine actuel** et s'il réutilise le même mot de passe. Cela pourrait nous permettre d'**escalader rapidement nos privilèges** si nous n'avons pas encore obtenu un accès élevé. Même si nous contrôlons déjà notre domaine actuel, la **réutilisation de mots de passe entre domaines similaires** est une faille importante à signaler dans notre rapport.

Si nous avons déjà **épuisé les options** dans notre domaine actuel, nous pouvons aussi essayer un **password spray** avec le mot de passe craqué sur les comptes de services, car les mêmes administrateurs peuvent gérer plusieurs domaines et utiliser des mots de passe identiques. Cela illustre l'importance des **tests itératifs** et de l'exploration approfondie de toutes les pistes possibles.

***

### <mark style="color:red;">Hunting Foreign Group Membership with Bloodhound-python</mark>

Dans certains cas, des **utilisateurs ou administrateurs d’un domaine** peuvent être **membres d’un groupe dans un autre domaine**, surtout si une **relation de confiance bidirectionnelle entre forêts** est en place. Étant donné que **seuls les Domain Local Groups acceptent des membres externes**, il est courant de voir un **utilisateur hautement privilégié** du **Domaine A** être membre du groupe **Administrators intégré du Domaine B**.

#### <mark style="color:green;">**Collecte d’informations avec BloodHound (Linux)**</mark>

* Si nous effectuons le test depuis un **hôte Linux**, nous pouvons utiliser la **version Python de BloodHound** pour collecter ces informations.
* Cet outil permet de **cartographier les relations entre plusieurs domaines** et d'identifier ces appartenances dans son interface graphique.

#### <mark style="color:green;">**Configuration DNS pour la collecte des données**</mark>

* Parfois, le client peut nous fournir une **machine virtuelle** qui obtient une **IP via DHCP** et utilise le **DNS interne du domaine**.
* Si nous utilisons un **hôte sans DNS configuré**, nous devons **modifier le fichier resolv.conf** pour que l’outil fonctionne.
* La configuration implique de **commenter les serveurs DNS actuels** et d’**ajouter le nom de domaine ainsi que l’adresse IP du contrôleur de domaine** cible (exemple : **ACADEMY-EA-DC01**).

Cela permet de **résoudre correctement le nom de domaine du contrôleur de domaine** et d'exécuter BloodHound sans problème.

<mark style="color:green;">**Adding INLANEFREIGHT.LOCAL Information to /etc/resolv.conf**</mark>

```shell-session
mrroboteLiot@htb[/htb]$ cat /etc/resolv.conf 

# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
# 127.0.0.53 is the systemd-resolved stub resolver.
# run "resolvectl status" to see details about the actual nameservers.

#nameserver 1.1.1.1
#nameserver 8.8.8.8
domain INLANEFREIGHT.LOCAL
nameserver 172.16.5.5
```

Once this is in place, we can run the tool against the target domain as follows:

<mark style="color:green;">**Running bloodhound-python Against INLANEFREIGHT.LOCAL**</mark>

{% code fullWidth="true" %}
```shell-session
mrroboteLiot@htb[/htb]$ bloodhound-python -d INLANEFREIGHT.LOCAL -dc ACADEMY-EA-DC01 -c All -u forend -p Klmcargo2
```
{% endcode %}

We can compress the resultant zip files to upload one single zip file directly into the BloodHound GUI.

<mark style="color:green;">**Compressing the File with zip -r**</mark>

```shell-session
mrroboteLiot@htb[/htb]$ zip -r ilfreight_bh.zip *.json
```

We will repeat the same process, this time filling in the details for the `FREIGHTLOGISTICS.LOCAL` domain.

<mark style="color:green;">**Adding FREIGHTLOGISTICS.LOCAL Information to /etc/resolv.conf**</mark>

```shell-session
mrroboteLiot@htb[/htb]$ cat /etc/resolv.conf 

# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
# 127.0.0.53 is the systemd-resolved stub resolver.
# run "resolvectl status" to see details about the actual nameservers.

#nameserver 1.1.1.1
#nameserver 8.8.8.8
domain FREIGHTLOGISTICS.LOCAL
nameserver 172.16.5.238
```

The `bloodhound-python` command will look similar to the previous one:

<mark style="color:green;">**Running bloodhound-python Against FREIGHTLOGISTICS.LOCAL**</mark>

{% code overflow="wrap" fullWidth="true" %}
```shell-session
mrroboteLiot@htb[/htb]$ bloodhound-python -d FREIGHTLOGISTICS.LOCAL -dc ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL -c All -u forend@inlanefreight.local -p Klmcargo2
```
{% endcode %}

After uploading the second set of data (either each JSON file or as one zip file), we can click on `Users with Foreign Domain Group Membership` under the `Analysis` tab and select the source domain as `INLANEFREIGHT.LOCAL`. Here, we will see the built-in Administrator account for the INLANEFREIGHT.LOCAL domain is a member of the built-in Administrators group in the FREIGHTLOGISTICS.LOCAL domain as we saw previously.

**Viewing Dangerous Rights through BloodHound**

![image](https://academy.hackthebox.com/storage/modules/143/foreign_membership.png)

***
